{% extends "base.html" %}
{% block title %}Gerar Sorteio{% endblock %}

{% block content %}
<div class="fade-in">
  <h1 class="text-center app-title mb-4">
    <i class="bi bi-shuffle me-2" style="color: var(--color-primary);"></i>
    Gerar Sorteio
  </h1>

  <!-- Informações dos Participantes -->
  <div class="glass-card mb-4 slide-in">
    <h3 class="text-center mb-3" style="color: var(--color-accent);">
      <i class="bi bi-people-fill me-2"></i>
      Participantes Confirmados
    </h3>
    <div class="row justify-content-center text-center">
      <div class="col-md-4 mb-2">
        <div style="font-size: 1.1rem;">
          <i class="bi bi-people me-2" style="color: var(--color-primary);"></i>
          <strong>Misto:</strong> 
          <span id="info-misto-h" style="color: var(--color-success);">{{ categorias_info.misto_h }}</span>H / 
          <span id="info-misto-f" style="color: var(--color-accent);">{{ categorias_info.misto_f }}</span>F
        </div>
      </div>
      <div class="col-md-4 mb-2">
        <div style="font-size: 1.1rem;">
          <i class="bi bi-person me-2" style="color: var(--color-success);"></i>
          <strong>Masculino:</strong> 
          <span id="info-masc" style="color: var(--color-success);">{{ categorias_info.masculino }}</span>
        </div>
      </div>
      <div class="col-md-4 mb-2">
        <div style="font-size: 1.1rem;">
          <i class="bi bi-person me-2" style="color: var(--color-accent);"></i>
          <strong>Feminino:</strong> 
          <span id="info-fem" style="color: var(--color-accent);">{{ categorias_info.feminino }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Configuração do Sorteio -->
  <div class="glass-card mb-4 slide-in">
    <h3 class="text-center mb-4" style="color: var(--color-text);">
      <i class="bi bi-gear me-2" style="color: var(--color-primary);"></i>
      Configuração do Sorteio
    </h3>

    <form id="form-gerar-sorteio">
      <div class="row justify-content-center">
        <div class="col-md-6 mb-3">
          <label for="categoria" class="form-label" style="color: var(--color-text); font-weight: 600;">
            <i class="bi bi-trophy me-2"></i>
            Categoria:
          </label>
          <select id="categoria" name="categoria" class="form-select form-select-lg" required>
            <option value="misto">Misto</option>
            <option value="masculino">Masculino</option>
            <option value="feminino">Feminino</option>
          </select>
          <small class="text-muted" id="info-categoria" style="display: block; margin-top: 5px;">
            Selecione a categoria para ver as opções disponíveis
          </small>
        </div>

        <div class="col-md-6 mb-3">
          <label for="jogos_por_pessoa" class="form-label" style="color: var(--color-text); font-weight: 600;">
            <i class="bi bi-123 me-2"></i>
            Quantos jogos cada pessoa fará?
          </label>
          <select id="jogos_por_pessoa" name="jogos_por_pessoa" class="form-select form-select-lg" required disabled>
            <option value="">Selecione a categoria primeiro</option>
          </select>
          <small class="text-muted" id="info-jogos" style="display: block; margin-top: 5px;">
            As opções serão carregadas automaticamente
          </small>
        </div>
      </div>

      <div class="text-center mt-4">
        <button type="button" id="btn-gerar" class="btn btn-primary-custom" disabled style="font-size: 1.2rem; padding: 15px 40px;">
          <i class="bi bi-play-circle me-2"></i>
          Gerar Sorteio
        </button>
      </div>
    </form>

    <div id="preview-viabilidade" class="mt-4" style="display: none;">
      <!-- Preview será preenchido via JavaScript -->
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const categoriaSelect = document.getElementById('categoria');
  const jogosSelect = document.getElementById('jogos_por_pessoa');
  const btnGerar = document.getElementById('btn-gerar');
  const previewDiv = document.getElementById('preview-viabilidade');
  const infoCategoria = document.getElementById('info-categoria');
  const infoJogos = document.getElementById('info-jogos');

  // Carrega informações dos participantes
  async function carregarInfoParticipantes() {
    try {
      const response = await fetch('/api/info_participantes');
      const data = await response.json();
      
      // Atualiza informações na tela
      document.getElementById('info-misto-h').textContent = data.misto.homens;
      document.getElementById('info-misto-f').textContent = data.misto.mulheres;
      document.getElementById('info-masc').textContent = data.masculino;
      document.getElementById('info-fem').textContent = data.feminino;
    } catch (error) {
      console.error('Erro ao carregar participantes:', error);
    }
  }

  // Carrega opções viáveis quando categoria muda
  categoriaSelect.addEventListener('change', async function() {
    const categoria = categoriaSelect.value;
    
    // Desabilita campos até carregar
    jogosSelect.disabled = true;
    jogosSelect.innerHTML = '<option value="">Carregando...</option>';
    btnGerar.disabled = true;
    previewDiv.style.display = 'none';

    try {
      const response = await fetch('/api/analisar_categoria', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ categoria })
      });

      const data = await response.json();

      if (data.viavel && data.opcoes && data.opcoes.length > 0) {
        // Preenche select com opções viáveis
        jogosSelect.innerHTML = '';
        data.opcoes.forEach(opcao => {
          const option = document.createElement('option');
          option.value = opcao.jogos_por_pessoa;
          option.textContent = `${opcao.jogos_por_pessoa} jogos (~${opcao.rodadas_estimadas} rodadas)`;
          if (opcao.jogos_por_pessoa === 5) {
            option.selected = true; // Seleciona 5 por padrão
          }
          jogosSelect.appendChild(option);
        });

        jogosSelect.disabled = false;
        infoCategoria.textContent = `✅ ${data.mensagem}`;
        infoCategoria.style.color = 'var(--color-success)';
        
        // Valida automaticamente a opção selecionada
        validarConfiguracao();
      } else {
        jogosSelect.innerHTML = '<option value="">Nenhuma opção viável</option>';
        infoCategoria.textContent = `❌ ${data.mensagem}`;
        infoCategoria.style.color = 'var(--color-danger)';
        previewDiv.innerHTML = `
          <div class="alert alert-danger">
            <h5><i class="bi bi-x-circle me-2"></i>Não é possível gerar sorteio</h5>
            <p>${data.mensagem}</p>
          </div>
        `;
        previewDiv.style.display = 'block';
      }
    } catch (error) {
      jogosSelect.innerHTML = '<option value="">Erro ao carregar</option>';
      infoCategoria.textContent = `Erro: ${error.message}`;
      infoCategoria.style.color = 'var(--color-danger)';
    }
  });

  // Valida configuração quando jogos por pessoa muda
  jogosSelect.addEventListener('change', validarConfiguracao);

  async function validarConfiguracao() {
    const categoria = categoriaSelect.value;
    const jogosPorPessoa = parseInt(jogosSelect.value);

    if (!categoria || !jogosPorPessoa) {
      btnGerar.disabled = true;
      previewDiv.style.display = 'none';
      return;
    }

    try {
      const response = await fetch('/api/analisar_categoria', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ categoria })
      });

      const data = await response.json();

      if (data.viavel) {
        const opcoes = data.opcoes || [];
        const opcaoValida = opcoes.find(op => op.jogos_por_pessoa === jogosPorPessoa);

        if (opcaoValida) {
          previewDiv.innerHTML = `
            <div class="alert alert-success" style="background: rgba(6, 214, 160, 0.2); border: 2px solid var(--color-success);">
              <h5><i class="bi bi-check-circle me-2"></i>Configuração Válida!</h5>
              <div class="row mt-3">
                <div class="col-md-4">
                  <strong><i class="bi bi-person-check me-2"></i>Cada pessoa jogará:</strong><br>
                  <span style="font-size: 1.3rem; color: var(--color-success);">${jogosPorPessoa} vezes</span>
                </div>
                <div class="col-md-4">
                  <strong><i class="bi bi-calendar-week me-2"></i>Rodadas estimadas:</strong><br>
                  <span style="font-size: 1.3rem; color: var(--color-primary);">~${opcaoValida.rodadas_estimadas}</span>
                </div>
                <div class="col-md-4">
                  <strong><i class="bi bi-people me-2"></i>Duplas necessárias:</strong><br>
                  <span style="font-size: 1.3rem; color: var(--color-accent);">${opcaoValida.duplas_necessarias}</span>
                </div>
              </div>
            </div>
          `;
          previewDiv.style.display = 'block';
          btnGerar.disabled = false;
          infoJogos.textContent = '✅ Configuração válida e pronta para gerar';
          infoJogos.style.color = 'var(--color-success)';
        } else {
          previewDiv.innerHTML = `
            <div class="alert alert-warning">
              <h5><i class="bi bi-exclamation-triangle me-2"></i>Configuração Inválida</h5>
              <p>O número de jogos selecionado (${jogosPorPessoa}) não é viável para esta categoria.</p>
              <p><strong>Opções viáveis:</strong> ${opcoes.map(op => op.jogos_por_pessoa).join(', ')}</p>
            </div>
          `;
          previewDiv.style.display = 'block';
          btnGerar.disabled = true;
          infoJogos.textContent = '⚠️ Selecione uma opção viável';
          infoJogos.style.color = 'var(--color-warning)';
        }
      } else {
        previewDiv.innerHTML = `
          <div class="alert alert-danger">
            <h5><i class="bi bi-x-circle me-2"></i>Não é possível gerar sorteio</h5>
            <p>${data.mensagem}</p>
          </div>
        `;
        previewDiv.style.display = 'block';
        btnGerar.disabled = true;
        infoJogos.textContent = '❌ Não é possível gerar sorteio';
        infoJogos.style.color = 'var(--color-danger)';
      }
    } catch (error) {
      previewDiv.innerHTML = `
        <div class="alert alert-danger">
          <h5><i class="bi bi-x-circle me-2"></i>Erro</h5>
          <p>Erro ao validar: ${error.message}</p>
        </div>
      `;
      previewDiv.style.display = 'block';
      btnGerar.disabled = true;
      infoJogos.textContent = '❌ Erro ao validar';
      infoJogos.style.color = 'var(--color-danger)';
    }
  }

  // Carrega informações iniciais
  carregarInfoParticipantes();
  
  // Carrega opções da categoria padrão (misto)
  categoriaSelect.dispatchEvent(new Event('change'));

  btnGerar.addEventListener('click', async function() {
    const categoria = categoriaSelect.value;
    const jogosPorPessoa = parseInt(jogosSelect.value);

    btnGerar.disabled = true;
    btnGerar.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Gerando...';

    try {
      const response = await fetch('/api/gerar-sorteio', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ categoria, jogos_por_pessoa: jogosPorPessoa })
      });

      const data = await response.json();

      if (data.sucesso) {
        window.location.href = `/rodadas?categoria=${categoria}`;
      } else {
        alert('Erro ao gerar sorteio: ' + (data.erro || 'Erro desconhecido'));
        btnGerar.disabled = false;
        btnGerar.innerHTML = '<i class="bi bi-play-circle me-2"></i>Gerar Sorteio';
      }
    } catch (error) {
      alert('Erro ao gerar sorteio: ' + error.message);
      btnGerar.disabled = false;
      btnGerar.innerHTML = '<i class="bi bi-play-circle me-2"></i>Gerar Sorteio';
    }
  });
});
</script>
{% endblock %}

