{% extends "base.html" %}
{% block title %}Gerar Sorteio{% endblock %}

{% block content %}
<div class="fade-in">
  <h1 class="text-center app-title mb-4">
    <i class="bi bi-shuffle me-2" style="color: var(--color-primary);"></i>
    Gerar Sorteio
  </h1>

  <!-- Informações dos Participantes -->
  <div class="glass-card mb-4 slide-in">
    <h3 class="text-center mb-3" style="color: var(--color-accent);">
      <i class="bi bi-people-fill me-2"></i>
      Participantes Confirmados
    </h3>
    <div class="row justify-content-center text-center">
      <div class="col-md-4 mb-2">
        <div style="font-size: 1.1rem;">
          <i class="bi bi-people me-2" style="color: var(--color-primary);"></i>
          <strong>Misto:</strong> 
          <span id="info-misto-h" style="color: var(--color-success);">{{ categorias_info.misto_h }}</span>H / 
          <span id="info-misto-f" style="color: var(--color-accent);">{{ categorias_info.misto_f }}</span>F
        </div>
      </div>
      <div class="col-md-4 mb-2">
        <div style="font-size: 1.1rem;">
          <i class="bi bi-person me-2" style="color: var(--color-success);"></i>
          <strong>Masculino:</strong> 
          <span id="info-masc" style="color: var(--color-success);">{{ categorias_info.masculino }}</span>
        </div>
      </div>
      <div class="col-md-4 mb-2">
        <div style="font-size: 1.1rem;">
          <i class="bi bi-person me-2" style="color: var(--color-accent);"></i>
          <strong>Feminino:</strong> 
          <span id="info-fem" style="color: var(--color-accent);">{{ categorias_info.feminino }}</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Configuração do Sorteio com Abas -->
  <div class="glass-card mb-4 slide-in">
    <h3 class="text-center mb-4" style="color: var(--color-text);">
      <i class="bi bi-gear me-2" style="color: var(--color-primary);"></i>
      Configuração do Sorteio
    </h3>

    <!-- Abas de Categorias -->
    <ul class="nav nav-pills nav-justified mb-4" id="categoria-tabs" role="tablist" style="border-bottom: 2px solid rgba(255,255,255,0.2);">
      <li class="nav-item" role="presentation">
        <button class="nav-link active categoria-tab" id="tab-misto" data-categoria="misto" 
                type="button" role="tab"
                style="background: rgba(0,123,255,0.3); color: var(--color-text); border: none; border-radius: 8px 8px 0 0; font-weight: 600;">
          <i class="bi bi-people-fill me-2"></i>
          Misto
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link categoria-tab" id="tab-masculino" data-categoria="masculino" 
                type="button" role="tab"
                style="background: rgba(0,123,255,0.1); color: var(--color-text); border: none; border-radius: 8px 8px 0 0; font-weight: 600;">
          <i class="bi bi-person-fill me-2"></i>
          Masculino
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link categoria-tab" id="tab-feminino" data-categoria="feminino" 
                type="button" role="tab"
                style="background: rgba(0,123,255,0.1); color: var(--color-text); border: none; border-radius: 8px 8px 0 0; font-weight: 600;">
          <i class="bi bi-person-fill me-2"></i>
          Feminino
        </button>
      </li>
    </ul>

    <!-- Conteúdo das Abas -->
    <div class="tab-content" id="categoria-tab-content">
      <!-- Aba Misto -->
      <div class="tab-pane categoria-pane active" id="pane-misto" role="tabpanel">
        <div id="config-misto">
          <div class="text-center mb-3">
            <p class="text-muted" id="info-misto">
              <i class="bi bi-hourglass-split me-1"></i>
              Analisando participantes...
            </p>
          </div>
          <div class="row justify-content-center mb-3">
            <div class="col-md-8">
              <label for="jogos-misto" class="form-label" style="color: var(--color-text); font-weight: 600;">
                <i class="bi bi-123 me-2"></i>
                Quantos jogos cada pessoa fará?
              </label>
              <select id="jogos-misto" class="form-select form-select-lg" disabled>
                <option value="">Carregando opções...</option>
              </select>
            </div>
          </div>
          <div id="preview-misto" class="mt-3" style="display: none;"></div>
          <div class="text-center mt-4">
            <button type="button" id="btn-gerar-misto" class="btn btn-primary-custom" disabled style="font-size: 1.2rem; padding: 15px 40px;">
              <i class="bi bi-play-circle me-2"></i>
              Gerar Sorteio Misto
            </button>
          </div>
        </div>
      </div>

      <!-- Aba Masculino -->
      <div class="tab-pane categoria-pane" id="pane-masculino" role="tabpanel" style="display: none;">
        <div id="config-masculino">
          <div class="text-center mb-3">
            <p class="text-muted" id="info-masculino">
              <i class="bi bi-hourglass-split me-1"></i>
              Analisando participantes...
            </p>
          </div>
          <div class="row justify-content-center mb-3">
            <div class="col-md-8">
              <label for="jogos-masculino" class="form-label" style="color: var(--color-text); font-weight: 600;">
                <i class="bi bi-123 me-2"></i>
                Quantos jogos cada pessoa fará?
              </label>
              <select id="jogos-masculino" class="form-select form-select-lg" disabled>
                <option value="">Carregando opções...</option>
              </select>
            </div>
          </div>
          <div id="preview-masculino" class="mt-3" style="display: none;"></div>
          <div class="text-center mt-4">
            <button type="button" id="btn-gerar-masculino" class="btn btn-primary-custom" disabled style="font-size: 1.2rem; padding: 15px 40px;">
              <i class="bi bi-play-circle me-2"></i>
              Gerar Sorteio Masculino
            </button>
          </div>
        </div>
      </div>

      <!-- Aba Feminino -->
      <div class="tab-pane categoria-pane" id="pane-feminino" role="tabpanel" style="display: none;">
        <div id="config-feminino">
          <div class="text-center mb-3">
            <p class="text-muted" id="info-feminino">
              <i class="bi bi-hourglass-split me-1"></i>
              Analisando participantes...
            </p>
          </div>
          <div class="row justify-content-center mb-3">
            <div class="col-md-8">
              <label for="jogos-feminino" class="form-label" style="color: var(--color-text); font-weight: 600;">
                <i class="bi bi-123 me-2"></i>
                Quantos jogos cada pessoa fará?
              </label>
              <select id="jogos-feminino" class="form-select form-select-lg" disabled>
                <option value="">Carregando opções...</option>
              </select>
            </div>
          </div>
          <div id="preview-feminino" class="mt-3" style="display: none;"></div>
          <div class="text-center mt-4">
            <button type="button" id="btn-gerar-feminino" class="btn btn-primary-custom" disabled style="font-size: 1.2rem; padding: 15px 40px;">
              <i class="bi bi-play-circle me-2"></i>
              Gerar Sorteio Feminino
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Elementos por categoria
  const elementos = {
    misto: {
      select: document.getElementById('jogos-misto'),
      btn: document.getElementById('btn-gerar-misto'),
      preview: document.getElementById('preview-misto'),
      info: document.getElementById('info-misto'),
      categoria: 'misto'
    },
    masculino: {
      select: document.getElementById('jogos-masculino'),
      btn: document.getElementById('btn-gerar-masculino'),
      preview: document.getElementById('preview-masculino'),
      info: document.getElementById('info-masculino'),
      categoria: 'masculino'
    },
    feminino: {
      select: document.getElementById('jogos-feminino'),
      btn: document.getElementById('btn-gerar-feminino'),
      preview: document.getElementById('preview-feminino'),
      info: document.getElementById('info-feminino'),
      categoria: 'feminino'
    }
  };

  // Carrega informações dos participantes
  async function carregarInfoParticipantes() {
    try {
      const response = await fetch('/api/info_participantes');
      const data = await response.json();
      
      // Atualiza informações na tela
      document.getElementById('info-misto-h').textContent = data.misto.homens;
      document.getElementById('info-misto-f').textContent = data.misto.mulheres;
      document.getElementById('info-masc').textContent = data.masculino;
      document.getElementById('info-fem').textContent = data.feminino;
    } catch (error) {
      console.error('Erro ao carregar participantes:', error);
    }
  }

  // Função para carregar opções de uma categoria
  async function carregarOpcoesCategoria(categoria) {
    const el = elementos[categoria];
    if (!el) return;
    
    el.select.disabled = true;
    el.select.innerHTML = '<option value="">Carregando...</option>';
    el.btn.disabled = true;
    el.preview.style.display = 'none';
    el.info.innerHTML = '<i class="bi bi-hourglass-split me-1"></i> Analisando participantes...';

    try {
      const response = await fetch('/api/analisar_categoria', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ categoria })
      });

      const data = await response.json();

      if (data.viavel && data.opcoes && data.opcoes.length > 0) {
        el.select.innerHTML = '';
        
        // Ordena opções por jogos_por_pessoa
        const opcoesOrdenadas = [...data.opcoes].sort((a, b) => a.jogos_por_pessoa - b.jogos_por_pessoa);
        
        opcoesOrdenadas.forEach(opcao => {
          const option = document.createElement('option');
          option.value = opcao.jogos_por_pessoa;
          option.textContent = `${opcao.jogos_por_pessoa} jogos (~${opcao.rodadas_estimadas} rodadas)`;
          
          // Seleciona a sugestão ou primeira opção
          if (data.sugestao && opcao.jogos_por_pessoa === data.sugestao.jogos_por_pessoa) {
            option.selected = true;
            option.textContent += ' ⭐';
          } else if (el.select.selectedIndex === -1 && opcao === opcoesOrdenadas[0]) {
            option.selected = true;
          }
          
          el.select.appendChild(option);
        });

        el.select.disabled = false;
        el.info.innerHTML = `
          <i class="bi bi-check-circle me-1" style="color: var(--color-success);"></i>
          <strong style="color: var(--color-success);">${data.mensagem}</strong><br>
          <small style="opacity: 0.8;">${opcoesOrdenadas.length} opção(ões) viável(is): ${opcoesOrdenadas.map(o => o.jogos_por_pessoa).join(', ')} jogos</small>
        `;
        
        // Valida automaticamente a opção selecionada
        validarConfiguracao(categoria);
      } else {
        el.select.innerHTML = '<option value="">Nenhuma opção viável</option>';
        el.info.innerHTML = `<i class="bi bi-x-circle me-1" style="color: var(--color-danger);"></i> <strong style="color: var(--color-danger);">${data.mensagem}</strong>`;
        el.preview.innerHTML = `
          <div class="alert alert-danger">
            <h5><i class="bi bi-x-circle me-2"></i>Não é possível gerar sorteio</h5>
            <p>${data.mensagem}</p>
          </div>
        `;
        el.preview.style.display = 'block';
      }
    } catch (error) {
      el.select.innerHTML = '<option value="">Erro ao carregar</option>';
      el.info.innerHTML = `<i class="bi bi-x-circle me-1" style="color: var(--color-danger);"></i> Erro: ${error.message}`;
    }
  }

  // Event listeners para mudança de abas (implementação manual sem Bootstrap JS)
  document.querySelectorAll('.categoria-tab').forEach(tab => {
    tab.addEventListener('click', function(event) {
      event.preventDefault();
      const categoria = this.getAttribute('data-categoria');
      
      // Remove active de todas as abas
      document.querySelectorAll('.categoria-tab').forEach(t => {
        t.classList.remove('active');
        t.style.background = 'rgba(0,123,255,0.1)';
      });
      
      // Esconde todos os panes
      document.querySelectorAll('.categoria-pane').forEach(p => {
        p.style.display = 'none';
        p.classList.remove('active');
      });
      
      // Ativa aba clicada
      this.classList.add('active');
      this.style.background = 'rgba(0,123,255,0.3)';
      
      // Mostra pane correspondente
      const pane = document.getElementById(`pane-${categoria}`);
      if (pane) {
        pane.style.display = 'block';
        pane.classList.add('active');
      }
      
      // Carrega opções se ainda não foram carregadas
      if (categoria && elementos[categoria].select.innerHTML.includes('Carregando') || 
          categoria && elementos[categoria].select.innerHTML.includes('Carregando opções')) {
        carregarOpcoesCategoria(categoria);
      } else if (categoria && elementos[categoria].select.value) {
        validarConfiguracao(categoria);
      }
    });
  });

  // Event listeners para mudança de jogos
  Object.keys(elementos).forEach(cat => {
    elementos[cat].select.addEventListener('change', () => validarConfiguracao(cat));
  });

  async function validarConfiguracao(categoria) {
    const el = elementos[categoria];
    if (!el) return;
    
    const jogosPorPessoa = parseInt(el.select.value);

    if (!jogosPorPessoa) {
      el.btn.disabled = true;
      el.preview.style.display = 'none';
      return;
    }

    try {
      const response = await fetch('/api/analisar_categoria', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ categoria })
      });

      const data = await response.json();

      if (data.viavel) {
        const opcoes = data.opcoes || [];
        const opcaoValida = opcoes.find(op => op.jogos_por_pessoa === jogosPorPessoa);

        if (opcaoValida) {
          el.preview.innerHTML = `
            <div class="alert alert-success" style="background: rgba(6, 214, 160, 0.2); border: 2px solid var(--color-success);">
              <h5><i class="bi bi-check-circle me-2"></i>Configuração Válida!</h5>
              <div class="row mt-3">
                <div class="col-md-4">
                  <strong><i class="bi bi-person-check me-2"></i>Cada pessoa jogará:</strong><br>
                  <span style="font-size: 1.3rem; color: var(--color-success);">${jogosPorPessoa} vezes</span>
                </div>
                <div class="col-md-4">
                  <strong><i class="bi bi-calendar-week me-2"></i>Rodadas estimadas:</strong><br>
                  <span style="font-size: 1.3rem; color: var(--color-primary);">~${opcaoValida.rodadas_estimadas}</span>
                </div>
                <div class="col-md-4">
                  <strong><i class="bi bi-people me-2"></i>Duplas necessárias:</strong><br>
                  <span style="font-size: 1.3rem; color: var(--color-accent);">${opcaoValida.duplas_necessarias}</span>
                </div>
              </div>
            </div>
          `;
          el.preview.style.display = 'block';
          el.btn.disabled = false;
        } else {
          el.preview.innerHTML = `
            <div class="alert alert-warning">
              <h5><i class="bi bi-exclamation-triangle me-2"></i>Configuração Inválida</h5>
              <p>O número de jogos selecionado (${jogosPorPessoa}) não é viável para esta categoria.</p>
              <p><strong>Opções viáveis:</strong> ${opcoes.map(op => op.jogos_por_pessoa).join(', ')}</p>
            </div>
          `;
          el.preview.style.display = 'block';
          el.btn.disabled = true;
        }
      } else {
        el.preview.innerHTML = `
          <div class="alert alert-danger">
            <h5><i class="bi bi-x-circle me-2"></i>Não é possível gerar sorteio</h5>
            <p>${data.mensagem}</p>
          </div>
        `;
        el.preview.style.display = 'block';
        el.btn.disabled = true;
      }
    } catch (error) {
      el.preview.innerHTML = `
        <div class="alert alert-danger">
          <h5><i class="bi bi-x-circle me-2"></i>Erro</h5>
          <p>Erro ao validar: ${error.message}</p>
        </div>
      `;
      el.preview.style.display = 'block';
      el.btn.disabled = true;
    }
  }

  // Função para gerar sorteio
  async function gerarSorteio(categoria) {
    const el = elementos[categoria];
    if (!el) return;
    
    const jogosPorPessoa = parseInt(el.select.value);
    
    el.btn.disabled = true;
    el.btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Gerando...';

    try {
      const response = await fetch('/api/gerar-sorteio', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ categoria, jogos_por_pessoa: jogosPorPessoa })
      });

      const data = await response.json();

      if (data.sucesso) {
        window.location.href = `/rodadas?categoria=${categoria}`;
      } else {
        alert('Erro ao gerar sorteio: ' + (data.erro || 'Erro desconhecido'));
        el.btn.disabled = false;
        el.btn.innerHTML = '<i class="bi bi-play-circle me-2"></i>Gerar Sorteio ' + (categoria === 'misto' ? 'Misto' : categoria === 'masculino' ? 'Masculino' : 'Feminino');
      }
    } catch (error) {
      alert('Erro ao gerar sorteio: ' + error.message);
      el.btn.disabled = false;
      el.btn.innerHTML = '<i class="bi bi-play-circle me-2"></i>Gerar Sorteio ' + (categoria === 'misto' ? 'Misto' : categoria === 'masculino' ? 'Masculino' : 'Feminino');
    }
  }

  // Event listeners para botões de gerar
  elementos.misto.btn.addEventListener('click', () => gerarSorteio('misto'));
  elementos.masculino.btn.addEventListener('click', () => gerarSorteio('masculino'));
  elementos.feminino.btn.addEventListener('click', () => gerarSorteio('feminino'));

  // Carrega informações iniciais e analisa automaticamente
  async function inicializar() {
    await carregarInfoParticipantes();
    // Carrega opções da categoria padrão (misto) automaticamente
    carregarOpcoesCategoria('misto');
  }
  
  // Inicializa ao carregar a página
  inicializar();
});
</script>
{% endblock %}

