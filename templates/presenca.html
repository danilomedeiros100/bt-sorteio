{% extends "base.html" %}
{% block title %}Confirmação de Presença{% endblock %}

{% block content %}
<div class="fade-in">

<h1 class="text-center app-title mb-4">
  <i class="bi bi-people-fill me-2" style="color: var(--color-primary);"></i>
  Participantes do Torneio
</h1>

<!-- Participantes Confirmados -->
<div class="glass-card text-center mb-4 slide-in">
  <h3 class="mb-3" style="color: var(--color-accent);">
    <i class="bi bi-check-circle-fill me-2"></i>
    Participantes Confirmados
  </h3>
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div style="font-size: 1.2rem; font-weight: 600;">
        <div class="mb-2">
          <i class="bi bi-people me-2" style="color: var(--color-primary);"></i>
          <strong>Mista:</strong> 
          Masc: <span id="cont-mista-m" style="color: var(--color-success);">{{ categorias.mista_m }}</span> | 
          Fem: <span id="cont-mista-f" style="color: var(--color-accent);">{{ categorias.mista_f }}</span> = 
          <span id="cont-mista-total" style="color: var(--color-text);">{{ categorias.mista_m + categorias.mista_f }}</span>
        </div>
        <div class="mb-2">
          <i class="bi bi-person me-2" style="color: var(--color-accent);"></i>
          <strong>Feminino:</strong> <span id="cont-fem" style="color: var(--color-accent);">{{ categorias.feminino }}</span>
        </div>
        <div>
          <i class="bi bi-person me-2" style="color: var(--color-success);"></i>
          <strong>Masculino:</strong> <span id="cont-masc" style="color: var(--color-success);">{{ categorias.masculino }}</span>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Formulário de confirmação -->
<div class="glass-card mb-4 slide-in" style="animation-delay: 0.1s;">
  <h3 class="text-center mb-4" style="color: var(--color-text);">
    <i class="bi bi-clipboard-check me-2" style="color: var(--color-primary);"></i>
    Confirmar Presença dos Jogadores
  </h3>
  <form id="form-presenca">
    <div class="row justify-content-center">
      <div class="col-md-8">
        {% for jogador in jogadores %}
          <div class="d-flex justify-content-between align-items-center mb-2 p-3 rounded" 
               style="background: rgba(255,255,255,0.05); transition: all 0.2s ease;"
               onmouseover="this.style.background='rgba(255,255,255,0.08)'"
               onmouseout="this.style.background='rgba(255,255,255,0.05)'">
            <div class="d-flex align-items-center">
              <input class="form-check-input me-3" 
                     type="checkbox" 
                     name="confirmado" 
                     value="{{ jogador.nome }}" 
                     id="jogador-{{ loop.index }}" 
                     {% if jogador.confirmado %}checked{% endif %}
                     style="width: 20px; height: 20px; cursor: pointer;">
              <label class="form-check-label" for="jogador-{{ loop.index }}" style="cursor: pointer; font-weight: 500;">
                <i class="bi bi-{% if jogador.sexo == 'M' %}gender-male{% else %}gender-female{% endif %} me-2" 
                   style="color: {% if jogador.sexo == 'M' %}var(--color-primary){% else %}var(--color-accent){% endif %};"></i>
                {{ jogador.nome }}
                <small class="text-muted">({{ 'Masculino' if jogador.sexo == 'M' else 'Feminino' }})</small>
              </label>
            </div>
            <button type="button" 
                    class="btn btn-sm" 
                    onclick="excluirJogador('{{ jogador.nome }}')"
                    style="background: var(--color-danger); color: white; border: none; padding: 6px 12px; border-radius: 6px;">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        {% endfor %}
      </div>
    </div>
  </form>
</div>

<!-- Formulário de cadastro/edição -->
<div class="glass-card mb-4 slide-in" style="animation-delay: 0.2s;">
  <h3 class="text-center mb-4" style="color: var(--color-text);">
    <i class="bi bi-person-plus-fill me-2" style="color: var(--color-success);"></i>
    Adicionar ou Editar Participante
  </h3>
  <form id="form-editar" onsubmit="salvarJogador(event)">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="mb-3">
          <label class="form-label-custom">
            <i class="bi bi-person me-2"></i>
            Nome do Jogador
          </label>
          <input type="text" class="form-control-custom" id="nome" placeholder="Digite o nome" required>
        </div>
        <div class="mb-3">
          <label class="form-label-custom">
            <i class="bi bi-gender-ambiguous me-2"></i>
            Sexo
          </label>
          <select class="form-select" id="sexo" required>
            <option value="">Selecione o Sexo</option>
            <option value="M">Masculino</option>
            <option value="F">Feminino</option>
          </select>
        </div>
        <div class="d-grid">
          <button type="submit" class="btn-primary-custom btn-success">
            <i class="bi bi-save me-2"></i>
            Salvar
          </button>
        </div>
      </div>
    </div>
  </form>
</div>

<!-- Botão para Gerar Rodadas -->
<div class="glass-card text-center mb-4 slide-in" style="animation-delay: 0.3s;">
  <h3 class="mb-3" style="color: var(--color-accent);">
    <i class="bi bi-dice-5-fill me-2"></i>
    Gerar Torneio de 5 Rodadas
  </h3>
  <p class="text-muted mb-4">
    Após confirmar todos os jogadores presentes, clique no botão abaixo para gerar as 5 rodadas automaticamente.
  </p>
  <button onclick="gerarRodadas()" class="btn-primary-custom btn-accent" style="font-size: 1.4rem; padding: 18px 40px;">
    <i class="bi bi-lightning-fill me-2"></i>
    GERAR 5 RODADAS
  </button>
  <div id="status-geracao" class="mt-3"></div>
</div>

<div style="height: 70px;"></div>

</div>
{% endblock %}

{% block scripts %}
<script>
  function atualizarTotais() {
    const checkboxes = document.querySelectorAll('input[name="confirmado"]');
    let mista_m = 0, mista_f = 0, masc = 0, fem = 0;

    checkboxes.forEach(cb => {
      if (cb.checked) {
        const label = cb.nextElementSibling.textContent.toLowerCase();
        const sexo = label.includes('masculino') ? 'M' : (label.includes('feminino') ? 'F' : '');

        if (sexo === 'M') mista_m++;
        if (sexo === 'F') mista_f++;
        masc = mista_m;
        fem = mista_f;
      }
    });

    document.getElementById('cont-mista-m').textContent = mista_m;
    document.getElementById('cont-mista-f').textContent = mista_f;
    document.getElementById('cont-mista-total').textContent = mista_m + mista_f;
    document.getElementById('cont-masc').textContent = masc;
    document.getElementById('cont-fem').textContent = fem;
  }

  function salvarJogador(event) {
    event.preventDefault();
    const nome = document.getElementById("nome").value.trim();
    const sexo = document.getElementById("sexo").value;

    if (!nome || !sexo) {
      alert("⚠️ Preencha o nome e o sexo.");
      return;
    }

    fetch("/adicionar_ou_editar_jogador", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nome, sexo, categorias: ["mista"] })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        alert("✅ Jogador salvo com sucesso.");
        location.reload();
      } else {
        alert("❌ Erro ao salvar jogador.");
      }
    });
  }

  function excluirJogador(nome) {
    if (!confirm(`⚠️ Deseja excluir o jogador ${nome}?`)) return;

    fetch("/excluir_jogador", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nome: nome })
    })
    .then(res => {
      if (res.ok) {
        alert("✅ Jogador excluído com sucesso!");
        location.reload();
      } else {
        alert("❌ Erro ao excluir jogador.");
      }
    })
    .catch(error => {
      console.error("Erro na exclusão:", error);
      alert("❌ Erro ao excluir jogador.");
    });
  }

  function gerarRodadas() {
    const statusDiv = document.getElementById("status-geracao");
    statusDiv.innerHTML = '<p style="color: var(--color-warning);"><i class="bi bi-hourglass-split me-2"></i>Gerando rodadas...</p>';

    fetch("/gerar-rodadas", {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    })
    .then(res => res.json())
    .then(data => {
      if (data.erro) {
        statusDiv.innerHTML = `<p style="color: var(--color-danger);"><i class="bi bi-x-circle me-2"></i>Erro: ${data.erro}</p>`;
      } else {
        statusDiv.innerHTML = `<p style="color: var(--color-success);"><i class="bi bi-check-circle me-2"></i>${data.total_rodadas} rodadas geradas com sucesso!</p>`;
        setTimeout(() => {
          window.location.href = "/rodadas";
        }, 1500);
      }
    })
    .catch(error => {
      statusDiv.innerHTML = `<p style="color: var(--color-danger);"><i class="bi bi-x-circle me-2"></i>Erro ao gerar rodadas</p>`;
      console.error("Erro:", error);
    });
  }

  document.querySelectorAll('input[name="confirmado"]').forEach(cb => {
    cb.addEventListener('change', () => {
      const checkboxes = document.querySelectorAll('input[name="confirmado"]:checked');
      const nomes = Array.from(checkboxes).map(cb => cb.value);

      fetch("{{ url_for('confirmar_presenca') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ confirmado: nomes })
      })
      .then(() => atualizarTotais())
      .catch(error => {
        console.error("Erro ao atualizar presença:", error);
      });
    });
  });
</script>
{% endblock %}
