{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <div class="glass-card text-center">
    <h2 class="mb-3">Participantes Confirmados</h2>
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="text-white fw-bold fs-5">
          <div class="mb-1">
            Mista: Masculino: <span id="cont-mista-m">{{ categorias.mista_m }}</span>
            Feminino: <span id="cont-mista-f">{{ categorias.mista_f }}</span>
            = <span id="cont-mista-total">{{ categorias.mista_m + categorias.mista_f }}</span>
          </div>
          <div class="mb-1">Feminino: <span id="cont-fem">{{ categorias.feminino }}</span></div>
          <div>Masculino: <span id="cont-masc">{{ categorias.masculino }}</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Formul√°rio de confirma√ß√£o -->
  <div class="glass-card text-center mt-5">
    <h2 class="mb-3">Confirmar Presen√ßa dos Jogadores</h2>
    <form id="form-presenca">
      <div class="row justify-content-center">
        <div class="col-md-8">
          {% for jogador in jogadores %}
            <div class="form-check mb-2 text-start d-flex justify-content-between align-items-center zebra-row py-2 px-3 rounded">
            <div>
              <div class="d-flex align-items-center">
  <input class="form-check-input me-2" type="checkbox" name="confirmado" value="{{ jogador.nome }}" id="jogador-{{ loop.index }}" {% if jogador.confirmado %}checked{% endif %}>
  <label class="form-check-label text-white" for="jogador-{{ loop.index }}">
    {{ jogador.nome }} ({{ jogador.sexo }})
  </label>
</div>
            </div>
            <button type="button" class="btn btn-sm btn-warning ms-2" onclick="excluirJogador('{{ jogador.nome }}')">Excluir</button>
          </div>
          {% endfor %}
        </div>
      </div>
    </form>
  </div>

  <!-- Formul√°rio de cadastro/edi√ß√£o -->
  <div class="glass-card text-center mt-5">
    <h2 class="mb-3">Adicionar ou Editar Participante</h2>
    <form id="form-editar" onsubmit="salvarJogador(event)">
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="mb-3">
            <input type="text" class="form-control" id="nome" placeholder="Nome do jogador" required>
          </div>
          <div class="mb-3">
            <select class="form-select" id="sexo" required>
              <option value="">Selecione o Sexo</option>
              <option value="M">Masculino</option>
              <option value="F">Feminino</option>
            </select>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-glass">Salvar</button>
          </div>
        </div>
      </div>
    </form>
  </div>

  <!-- Bot√£o para Gerar Rodadas -->
  <div class="glass-card text-center mt-4">
    <h2 class="mb-3">üé≤ Gerar Torneio de 5 Rodadas</h2>
    <p class="text-white">Ap√≥s confirmar todos os jogadores presentes, clique no bot√£o abaixo para gerar as 5 rodadas automaticamente.</p>
    <button onclick="gerarRodadas()" class="btn btn-glass" style="font-size: 1.5rem; padding: 20px;">
      ‚ö° GERAR 5 RODADAS
    </button>
    <div id="status-geracao" class="mt-3"></div>
  </div>
</div>

<script>
  function atualizarTotais() {
    const checkboxes = document.querySelectorAll('input[name="confirmado"]');
    let mista_m = 0, mista_f = 0, masc = 0, fem = 0;

    checkboxes.forEach(cb => {
      if (cb.checked) {
        const label = cb.nextElementSibling.textContent.toLowerCase();
        const sexo = label.includes('(m)') ? 'M' : (label.includes('(f)') ? 'F' : '');

        if (sexo === 'M') mista_m++;
        if (sexo === 'F') mista_f++;
        masc = mista_m;
        fem = mista_f;
      }
    });

    document.getElementById('cont-mista-m').textContent = mista_m;
    document.getElementById('cont-mista-f').textContent = mista_f;
    document.getElementById('cont-mista-total').textContent = mista_m + mista_f;
    document.getElementById('cont-masc').textContent = masc;
    document.getElementById('cont-fem').textContent = fem;
  }

  function salvarJogador(event) {
    event.preventDefault();
    const nome = document.getElementById("nome").value.trim();
    const sexo = document.getElementById("sexo").value;

    if (!nome || !sexo) {
      alert("Preencha o nome e o sexo.");
      return;
    }

    fetch("/adicionar_ou_editar_jogador", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nome, sexo, categorias: ["mista"] })
    })
    .then(res => res.json())
    .then(data => {
      if (data.status === "ok") {
        alert("Jogador salvo com sucesso.");
        location.reload();
      } else {
        alert("Erro ao salvar jogador.");
      }
    });
  }

  function excluirJogador(nome) {
    if (!confirm(`Deseja excluir o jogador ${nome}?`)) return;

    fetch("/excluir_jogador", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ nome: nome })
    })
    .then(res => {
      if (res.ok) {
        location.reload();
      } else {
        alert("Erro ao excluir jogador.");
      }
    })
    .catch(error => {
      console.error("Erro na exclus√£o:", error);
      alert("Erro ao excluir jogador.");
    });
  }

  function gerarRodadas() {
    const statusDiv = document.getElementById("status-geracao");
    statusDiv.innerHTML = '<p class="text-white">‚è≥ Gerando rodadas...</p>';

    fetch("/gerar-rodadas", {
      method: "POST",
      headers: { "Content-Type": "application/json" }
    })
    .then(res => res.json())
    .then(data => {
      if (data.erro) {
        statusDiv.innerHTML = `<p class="text-danger">‚ùå Erro: ${data.erro}</p>`;
      } else {
        statusDiv.innerHTML = `<p class="text-success">‚úÖ ${data.total_rodadas} rodadas geradas com sucesso!</p>`;
        setTimeout(() => {
          window.location.href = "/rodadas";
        }, 1500);
      }
    })
    .catch(error => {
      statusDiv.innerHTML = `<p class="text-danger">‚ùå Erro ao gerar rodadas</p>`;
      console.error("Erro:", error);
    });
  }

  document.querySelectorAll('input[name="confirmado"]').forEach(cb => {
    cb.addEventListener('change', () => {
      const checkboxes = document.querySelectorAll('input[name="confirmado"]:checked');
      const nomes = Array.from(checkboxes).map(cb => cb.value);

      fetch("{{ url_for('confirmar_presenca') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ confirmado: nomes })
      })
      .then(() => atualizarTotais())
      .catch(error => {
        console.error("Erro ao atualizar presen√ßa:", error);
      });
    });
  });
</script>
{% endblock %}