{% extends 'base.html' %}
{% block title %}Registrar Resultados{% endblock %}

{% block content %}
<h1 class="text-center display-5 fw-bold mb-4">üìù Registrar Resultados</h1>

<div class="glass-card text-center mb-4">
  <p class="text-white">
    Insira os games de cada dupla. <strong>M√≠nimo de 6 games para vencer</strong> (ou 7 no tiebreak).
  </p>
  <p class="text-warning mb-0">
    <small>O ranking ser√° atualizado automaticamente ap√≥s cada resultado!</small>
  </p>
</div>

{% for rodada in dados.rodadas %}
  <div class="glass-card mb-4">
    <h2 class="text-center mb-3">
      üìç RODADA {{ rodada.numero }}
    </h2>
    
    {% for confronto in rodada.confrontos %}
      <div class="matchup p-3 mb-3" style="background-color: rgba(255,255,255,0.05); border-radius: 10px;">
        <div class="text-center mb-3">
          <strong class="text-white" style="font-size: 1.1rem;">Quadra {{ confronto.quadra }}</strong>
        </div>
        
        <form class="resultado-form" data-rodada="{{ rodada.numero }}" data-confronto="{{ loop.index0 }}">
          <!-- Confronto na mesma linha -->
          <div class="d-flex flex-wrap align-items-center justify-content-center gap-2 mb-3">
            <!-- Input Dupla 1 -->
            <input 
              type="number" 
              class="form-control text-center fw-bold" 
              name="games_dupla1" 
              min="0" 
              max="7" 
              value="{{ confronto.resultado.games_dupla1 if confronto.resultado.finalizado else '' }}" 
              required
              placeholder="0"
              style="width: 50px; font-size: 1.2rem;"
            >
            
            <!-- Dupla 1 -->
            <div class="text-white fw-bold">
              {{ confronto.dupla1.jogador1 }} & {{ confronto.dupla1.jogador2 }}
            </div>
            
            <!-- VS -->
            <div class="text-white fw-bold px-2">VS</div>
            
            <!-- Dupla 2 -->
            <div class="text-white fw-bold">
              {{ confronto.dupla2.jogador1 }} & {{ confronto.dupla2.jogador2 }}
            </div>
            
            <!-- Input Dupla 2 -->
            <input 
              type="number" 
              class="form-control text-center fw-bold" 
              name="games_dupla2" 
              min="0" 
              max="7" 
              value="{{ confronto.resultado.games_dupla2 if confronto.resultado.finalizado else '' }}" 
              required
              placeholder="0"
              style="width: 50px; font-size: 1.2rem;"
            >
          </div>
          
          <!-- Bot√£o -->
          <div class="text-center">
            <button type="submit" class="btn btn-success w-100">
              {% if confronto.resultado.finalizado %}
                ‚úèÔ∏è Atualizar Resultado
              {% else %}
                ‚úÖ Salvar Resultado
              {% endif %}
            </button>
          </div>
        </form>
      </div>
    {% endfor %}
  </div>
{% endfor %}

<div class="text-center mb-5">
  <a href="{{ url_for('rota_ver_rodadas') }}" class="btn btn-glass">
    ‚¨Ö Ver Todas as Rodadas
  </a>
  <a href="{{ url_for('rota_ranking_individual') }}" class="btn btn-glass">
    üèÜ Ver Ranking
  </a>
</div>

<div style="height: 70px;"></div>

<script>
document.querySelectorAll('.resultado-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const rodada = form.dataset.rodada;
    const confronto = form.dataset.confronto;
    
    const games1 = parseInt(formData.get('games_dupla1'));
    const games2 = parseInt(formData.get('games_dupla2'));
    
    // Valida√ß√£o b√°sica
    if (games1 < 0 || games2 < 0) {
      alert('Games n√£o podem ser negativos!');
      return;
    }
    
    if (games1 < 6 && games2 < 6) {
      alert('Pelo menos uma dupla deve ter 6 ou mais games!');
      return;
    }
    
    if (games1 > 7 || games2 > 7) {
      alert('M√°ximo de 7 games no tiebreak!');
      return;
    }
    
    // Salva via fetch
    try {
      const btn = form.querySelector('button[type="submit"]');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '‚è≥ Salvando...';
      
      const response = await fetch('/salvar-resultado', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          rodada: rodada,
          confronto: confronto,
          games_dupla1: games1,
          games_dupla2: games2
        })
      });
      
      const data = await response.json();
      
      if (data.erro) {
        alert('Erro: ' + data.erro);
        btn.disabled = false;
        btn.innerHTML = originalText;
      } else {
        btn.innerHTML = '‚úÖ Salvo!';
        setTimeout(() => {
          location.reload();
        }, 800);
      }
    } catch (error) {
      alert('Erro ao salvar resultado!');
      console.error(error);
    }
  });
});
</script>

{% endblock %}

