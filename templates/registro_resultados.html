{% extends 'base.html' %}
{% block title %}Registrar Resultados{% endblock %}

{% block content %}
<div class="fade-in">

<h1 class="text-center app-title mb-4">
  <i class="bi bi-pencil-square me-2" style="color: var(--color-success);"></i>
  Registrar Resultados
</h1>

<div class="glass-card text-center mb-4 slide-in">
  <p class="mb-2">
    <i class="bi bi-info-circle me-2" style="color: var(--color-primary);"></i>
    Insira os games de cada dupla. <strong>Mínimo de 6 games para vencer</strong> (ou 7 no tiebreak).
  </p>
  <p class="mb-0" style="color: var(--color-warning);">
    <i class="bi bi-lightning-fill me-2"></i>
    <small>O ranking será atualizado automaticamente após cada resultado!</small>
  </p>
</div>

{% for rodada in dados.rodadas %}
  <div class="glass-card mb-4 slide-in" style="animation-delay: {{ 0.1 * loop.index }}s;">
    <h2 class="text-center mb-4" style="color: var(--color-accent); font-size: 1.6rem;">
      <i class="bi bi-circle-fill me-2" style="font-size: 0.7rem;"></i>
      RODADA {{ rodada.numero }}
    </h2>
    
    {% for confronto in rodada.confrontos %}
      <div class="matchup-container mb-3">
        <div class="matchup-quadra">
          <span class="badge">
            <i class="bi bi-geo-alt-fill me-1"></i>
            Quadra {{ confronto.quadra }}
          </span>
        </div>
        
        <form class="resultado-form" data-rodada="{{ rodada.numero }}" data-confronto="{{ loop.index0 }}">
          <!-- Confronto na mesma linha -->
          <div class="d-flex flex-wrap align-items-center justify-content-center gap-2 mb-3">
            <!-- Input Dupla 1 -->
            <input 
              type="number" 
              class="form-control text-center fw-bold" 
              name="games_dupla1" 
              min="0" 
              max="7" 
              value="{{ confronto.resultado.games_dupla1 if confronto.resultado.finalizado else '' }}" 
              required
              placeholder="0"
              style="width: 60px; height: 50px; font-size: 1.3rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: var(--color-text);"
            >
            
            <!-- Dupla 1 -->
            <div style="font-weight: 600; color: var(--color-text);">
              {{ confronto.dupla1.jogador1 }} <span style="color: rgba(255,255,255,0.5);">&</span> {{ confronto.dupla1.jogador2 }}
            </div>
            
            <!-- VS -->
            <div class="matchup-vs">VS</div>
            
            <!-- Dupla 2 -->
            <div style="font-weight: 600; color: var(--color-text);">
              {{ confronto.dupla2.jogador1 }} <span style="color: rgba(255,255,255,0.5);">&</span> {{ confronto.dupla2.jogador2 }}
            </div>
            
            <!-- Input Dupla 2 -->
            <input 
              type="number" 
              class="form-control text-center fw-bold" 
              name="games_dupla2" 
              min="0" 
              max="7" 
              value="{{ confronto.resultado.games_dupla2 if confronto.resultado.finalizado else '' }}" 
              required
              placeholder="0"
              style="width: 60px; height: 50px; font-size: 1.3rem; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: var(--color-text);"
            >
          </div>
          
          <!-- Botão -->
          <div class="text-center">
            <button type="submit" class="btn-primary-custom btn-success w-100">
              {% if confronto.resultado.finalizado %}
                <i class="bi bi-pencil me-2"></i>
                Atualizar Resultado
              {% else %}
                <i class="bi bi-check-circle me-2"></i>
                Salvar Resultado
              {% endif %}
            </button>
          </div>
        </form>
      </div>
    {% endfor %}
  </div>
{% endfor %}

<div class="text-center mb-4">
  <a href="{{ url_for('rota_ver_rodadas') }}" class="btn-primary-custom me-2">
    <i class="bi bi-calendar-event me-2"></i>
    Ver Todas as Rodadas
  </a>
  <a href="{{ url_for('rota_ranking_individual') }}" class="btn-primary-custom btn-accent">
    <i class="bi bi-bar-chart-fill me-2"></i>
    Ver Ranking
  </a>
</div>

<div style="height: 70px;"></div>

</div>
{% endblock %}

{% block scripts %}
<script>
document.querySelectorAll('.resultado-form').forEach(form => {
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    const rodada = form.dataset.rodada;
    const confronto = form.dataset.confronto;
    
    const games1 = parseInt(formData.get('games_dupla1'));
    const games2 = parseInt(formData.get('games_dupla2'));
    
    // Validação básica
    if (games1 < 0 || games2 < 0) {
      alert('❌ Games não podem ser negativos!');
      return;
    }
    
    if (games1 < 6 && games2 < 6) {
      alert('❌ Pelo menos uma dupla deve ter 6 ou mais games!');
      return;
    }
    
    if (games1 > 7 || games2 > 7) {
      alert('❌ Máximo de 7 games no tiebreak!');
      return;
    }
    
    // Salva via fetch
    try {
      const btn = form.querySelector('button[type="submit"]');
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i> Salvando...';
      
      const response = await fetch('/salvar-resultado', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({
          rodada: rodada,
          confronto: confronto,
          games_dupla1: games1,
          games_dupla2: games2
        })
      });
      
      const data = await response.json();
      
      if (data.erro) {
        alert('❌ Erro: ' + data.erro);
        btn.disabled = false;
        btn.innerHTML = originalText;
      } else {
        btn.innerHTML = '<i class="bi bi-check-circle me-2"></i> Salvo!';
        setTimeout(() => {
          location.reload();
        }, 800);
      }
    } catch (error) {
      alert('❌ Erro ao salvar resultado!');
      console.error(error);
    }
  });
});
</script>
{% endblock %}
